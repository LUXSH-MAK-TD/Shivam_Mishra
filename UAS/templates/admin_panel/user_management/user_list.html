{% extends 'base.html' %}
{% block title %}User List{% endblock title %}

{% block content %}
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'css/user_css/user_list.css' %}">
<form id="user-list-form">
    <table>
        <thead>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Full Name</th>
                <th>Status</th>
                <th>Locked</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="user-table-body">
            <!-- Rows will be dynamically populated here -->
        </tbody>
    </table>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('User list loaded.');
        const accessToken = sessionStorage.getItem('access');

        if (!accessToken) {
            alert('Session expired. Please log in again.');
            window.location.href = "{% url 'login' %}";
            return;
        }

        fetch('http://127.0.0.1:5000/uas_admin/api/user_list/', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + accessToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(err => { 
                    throw new Error(err || "Failed to fetch user list"); 
                });
            }
            return response.json();
        })
        .then(data => {
            console.log("Fetched user list:", data);
            const tableBody = document.getElementById('user-table-body');
            tableBody.innerHTML = ''; // Clear existing rows
            data.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><a href="/uas_admin/user_details/?id=${user.id}" class="user-link">${user.username}</a></td>
                    <td>${user.email}</td>
                    <td>${user.full_name}</td>
                    <td>${user.is_active ? 'Active' : 'Inactive'}</td>
                    <td>${user.is_locked ? 'Yes' : 'No'}</td>
                    <td><button class="delete-btn" data-id="${user.id}">Delete</button></td>
                `;
                tableBody.appendChild(row);
            });

            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const userId = this.getAttribute('data-id');
                    if (confirm('Are you sure you want to delete this user?')) {
                        const deleteButton = this;
                        deleteButton.disabled = true; // Disable the button
                        deleteButton.textContent = 'Deleting...'; // Show loading text
                        fetch(`http://127.0.0.1:5000/uas_admin/api/delete_user/${userId}/`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': 'Bearer ' + accessToken,
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => {
                            if (!response.ok) {
                                return response.text().then(err => { 
                                    throw new Error(err || "Failed to delete user"); 
                                });
                            }
                            return response.json();
                        })
                        .then(() => {
                            alert('User deleted successfully.');
                            deleteButton.closest('tr').remove();
                        })
                        .catch(error => {
                            console.error("Error deleting user:", error);
                            alert("Failed to delete user. Please try again.");
                        })
                        .finally(() => {
                            deleteButton.disabled = false; // Re-enable the button
                            deleteButton.textContent = 'Delete'; // Reset button text
                        });
                    }
                });
            });
        })
        .catch(error => {
            console.error("Error fetching user list:", error);
            alert("Failed to load user list. Please try again.");
        });
    });
</script>

{% endblock content %}
