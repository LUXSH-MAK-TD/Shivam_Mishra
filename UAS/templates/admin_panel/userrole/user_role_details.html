{% extends 'base.html' %}
{% block title %}Update User Role{% endblock title %}

{% block content %}
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'css/user_css/update_user_role.css' %}">
<form id="update-user-role-form">
    <div>
        <label for="username">Username:</label>
        <input type="text" id="username" name="username" readonly>
    </div>
    <div>
        <label for="roles">Roles:</label>
        <select id="roles" name="roles" multiple>
            <!-- Options will be dynamically populated -->
        </select>
    </div>
    <button type="submit" id="update-role-btn">Update Roles</button>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Update User Role page loaded.');
        const accessToken = sessionStorage.getItem('access');
        const userId = new URLSearchParams(window.location.search).get('id');

        if (!accessToken) {
            alert('Session expired. Please log in again.');
            window.location.href = "{% url 'login' %}";
            return;
        }

        if (!userId) {
            alert('User ID is missing.');
            window.location.href = "{% url 'user-role-list' %}";
            return;
        }

        // Fetch user details and roles
        fetch(`http://127.0.0.1:5000/uas_admin/api/user_role_details/${userId}/`, {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + accessToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(err => { 
                    throw new Error(err || "Failed to fetch user role details"); 
                });
            }
            return response.json();
        })
        .then(data => {
            console.log("Fetched user role details:", data);
            document.getElementById('username').value = data.user_role_details.user;

            const rolesDropdown = document.getElementById('roles');
            fetch('http://127.0.0.1:5000/uas_admin/api/role_list/', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(err => { 
                        throw new Error(err || "Failed to fetch roles"); 
                    });
                }
                return response.json();
            })
            .then(roles => {
                roles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.id;
                    option.textContent = role.name;
                    if (data.user_role_details.role === role.name) {
                        option.selected = true;
                    }
                    rolesDropdown.appendChild(option);
                });
            })
            .catch(error => {
                console.error("Error fetching roles:", error);
                alert("Failed to load roles. Please try again.");
            });
        })
        .catch(error => {
            console.error("Error fetching user role details:", error);
            alert("Failed to load user role details. Please try again.");
        });

        // Handle form submission
        document.getElementById('update-user-role-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const selectedRoles = Array.from(document.getElementById('roles').selectedOptions).map(option => option.value);

            fetch('http://127.0.0.1:5000/uas_admin/api/update_user_role/', {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: userId,
                    role: selectedRoles
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(err => { 
                        throw new Error(err || "Failed to update user roles"); 
                    });
                }
                return response.json();
            })
            .then(() => {
                alert('User roles updated successfully.');
                window.location.href = "{% url 'user-role-list' %}";
            })
            .catch(error => {
                console.error("Error updating user roles:", error);
                alert("Failed to update user roles. Please try again.");
            });
        });
    });
</script>
{% endblock content %}
