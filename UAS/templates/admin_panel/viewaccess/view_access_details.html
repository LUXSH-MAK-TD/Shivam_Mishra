{% extends 'base.html' %}
{% block title %}Update View Access{% endblock title %}

{% block content %}
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'css/view_access/view_access_details.css' %}">

<h2>Update View Access</h2>

<form id="view-access-update-form">
    <label for="view_name">View Name:</label>
    <input type="text" id="view_name" name="view_name" disabled>
    
    <label for="roles">Select Roles:</label>
    <select id="roles" name="roles" multiple>
        <!-- Roles will be dynamically populated here -->
    </select>

    <button type="submit">Update</button>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Update View Access page loaded.');
        const accessToken = sessionStorage.getItem('access');
        const viewAccessId = new URLSearchParams(window.location.search).get('id');

        if (!accessToken) {
            alert('Session expired. Please log in again.');
            window.location.href = "{% url 'login' %}";
            return;
        }

        if (!viewAccessId) {
            alert('View Access ID is missing.');
            window.location.href = "{% url 'view-access-list' %}";
            return;
        }

        // Fetch view access details
        fetch(`http://127.0.0.1:5000/uas_admin/api/view_access_list/`, {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + accessToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(err => { 
                    throw new Error(err || "Failed to fetch view access details"); 
                });
            }
            return response.json();
        })
        .then(data => {
            const viewAccess = data.find(item => item.id == viewAccessId);
            if (!viewAccess) {
                alert("View Access not found.");
                window.location.href = "{% url 'view-access-list' %}";
                return;
            }

            document.getElementById('view_name').value = viewAccess.view_name;

            const rolesDropdown = document.getElementById('roles');
            fetch('http://127.0.0.1:5000/uas_admin/api/role_list/', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(err => { 
                        throw new Error(err || "Failed to fetch roles"); 
                    });
                }
                return response.json();
            })
            .then(rolesData => {
                rolesDropdown.innerHTML = ''; // Clear existing options
                rolesData.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.id;
                    option.textContent = role.name;
                    if (viewAccess.roles.some(viewRole => viewRole.id === role.id)) { // Match by role ID
                        option.selected = true;
                    }
                    rolesDropdown.appendChild(option);
                });
            })
            .catch(error => {
                console.error("Error fetching roles:", error);
                alert("Failed to load roles. Please try again.");
            });
        })
        .catch(error => {
            console.error("Error fetching data:", error);
            alert("An error occurred while fetching data. Please try again.");
        });

        // Handle form submission
        document.getElementById('view-access-update-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const selectedRoles = Array.from(document.getElementById('roles').selectedOptions).map(option => parseInt(option.value));

            fetch('http://127.0.0.1:5000/uas_admin/api/update_view_access/', {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: viewAccessId,
                    roles: selectedRoles
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { 
                        throw new Error(err.error || "Failed to update view access"); 
                    });
                }
                return response.json();
            })
            .then(() => {
                alert('View access updated successfully.');
                window.location.href = "{% url 'view-access-list' %}";
            })
            .catch(error => {
                console.error("Error updating view access:", error);
                alert(error.message || "Failed to update view access. Please try again.");
            });
        });
    });
</script>

{% endblock content %}
