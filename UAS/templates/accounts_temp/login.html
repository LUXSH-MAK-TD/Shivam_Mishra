{% extends 'base.html' %}

{% block title %}Login{% endblock title %}

{% block content %}
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'css/login.css' %}">
<h2>Login</h2>
<form id="login-form">
    {% csrf_token %}
    <label for="username">Username:</label>
    <input type="text" id="username" name="username" required>
    <br>
    <label for="password">Password:</label>
    <input type="password" id="password" name="password" required>
    <br>
    <button type="submit">Login</button>
</form>
<p id="login-message"></p>

<script>
    // Function to get CSRF token from cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.getElementById('login-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        
        const data = {
            username: document.getElementById('username').value,
            password: document.getElementById('password').value,
        };

        try {
            const response = await fetch("{% url 'api-login' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),  // Get CSRF token
                },
                body: JSON.stringify(data),
            });

            const contentType = response.headers.get('Content-Type');
            let result;
            if (contentType && contentType.includes('application/json')) {
                result = await response.json();
            } else {
                throw new Error('Response is not JSON');
            }

            console.log("API Response:", result); // Debugging log

            const messageElement = document.getElementById('login-message');

            if (response.ok) {
                if (result.message) {
                    messageElement.innerText = 'OTP has been sent to your email.';
                    // Redirect to OTP verification page
                    setTimeout(() => {
                        window.location.href = "{% url 'verify-otp' %}";
                    }, 1000); // Redirect after 2 seconds
                } else if (result.access) {
                    // Redirect or store token if MFA is disabled
                    localStorage.setItem("access_token", result.access);
                    window.location.href = "/request-reset-password"; 
                } else {
                    messageElement.innerText = 'Unexpected response format.';
                }
            } else {
                messageElement.innerText = result.error || 'Login failed.';
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('login-message').innerText = 'Something went wrong. Please try again.';
        }
    });
</script>
{% endblock content %}