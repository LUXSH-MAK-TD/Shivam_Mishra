{% extends 'base.html' %}
{% block title %}Logout{% endblock title %}

{% block content %}
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'css/logout.css' %}">
<h2>Logout</h2>
<form id="logout-form">
    <button type="submit">Logout</button>
</form>
<script>
    document.getElementById('logout-form').addEventListener('submit', function(e) {
        e.preventDefault();

        console.log('access', sessionStorage.getItem('access'));
        console.log('Refresh-Token', sessionStorage.getItem('Refresh-Token'));

        const accessToken = sessionStorage.getItem('access');
        const refreshToken = sessionStorage.getItem('Refresh-Token');

        if (!refreshToken) {
        console.warn("No refresh token found in session storage.");
        alert("Session expired. Please log in again.");
        window.location.href = "{% url 'login' %}";
        return;
        }

        fetch('http://127.0.0.1:5000/accounts/api/logout/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + sessionStorage.getItem('access'),
                'Refresh-Token': refreshToken 
            },
        })
        .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || "Logout failed"); });
        }
        return response.json();
        })
        .then(data => {
        console.log("Logout successful:", data);
        sessionStorage.removeItem('access');
        sessionStorage.removeItem('Refresh-Token'); 
        window.location.href = "{% url 'login' %}";
        })
        .catch(error => {
        console.error("Logout error:", error);
        alert(error.message);
    });
});
</script>
{% endblock content %}